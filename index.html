<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HalalFind AI - Complete Halal Discovery Platform</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#059669">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .feature-card { transition: all 0.3s ease; }
        .feature-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
        .chat-message { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-dots span {
            animation: blink 1.4s infinite;
        }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }
        .tab-active {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-emerald-50 via-teal-50 to-green-50 min-h-screen">
    
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-4xl">üïå</span>
                    <div>
                        <h1 class="text-2xl font-bold text-emerald-800">HalalFind AI</h1>
                        <p class="text-xs text-slate-600">Your Complete Halal Discovery Platform</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="manageAPIKey()" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition text-sm font-semibold">
                        ‚öôÔ∏è Settings
                    </button>
                    <button onclick="showSection('chat')" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition text-sm font-semibold">
                        üí¨ Chat Now
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        
        <!-- Main Navigation Tabs -->
        <div class="bg-white rounded-2xl shadow-xl p-2 mb-8 overflow-x-auto">
            <div class="flex gap-2 min-w-max">
                <button onclick="showSection('home')" id="tab-home" class="tab-active px-6 py-3 rounded-lg font-semibold transition whitespace-nowrap">
                    üè† Home
                </button>
                <button onclick="showSection('restaurant')" id="tab-restaurant" class="px-6 py-3 rounded-lg font-semibold transition hover:bg-emerald-50 whitespace-nowrap">
                    üçΩÔ∏è Find Restaurants
                </button>
                <button onclick="showSection('ingredient')" id="tab-ingredient" class="px-6 py-3 rounded-lg font-semibold transition hover:bg-emerald-50 whitespace-nowrap">
                    üîç Check Ingredients
                </button>
                <button onclick="showSection('travel')" id="tab-travel" class="px-6 py-3 rounded-lg font-semibold transition hover:bg-emerald-50 whitespace-nowrap">
                    ‚úàÔ∏è Travel Guide
                </button>
                <button onclick="showSection('recipe')" id="tab-recipe" class="px-6 py-3 rounded-lg font-semibold transition hover:bg-emerald-50 whitespace-nowrap">
                    üë®‚Äçüç≥ Recipes
                </button>
                <button onclick="showSection('chat')" id="tab-chat" class="px-6 py-3 rounded-lg font-semibold transition hover:bg-emerald-50 whitespace-nowrap">
                    üí¨ AI Chat
                </button>
            </div>
        </div>

        <!-- HOME SECTION -->
        <div id="section-home" class="section-content">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold text-emerald-800 mb-4">Assalamu Alaikum! üåô</h2>
                <p class="text-xl text-slate-600 max-w-2xl mx-auto">Your intelligent companion for discovering Halal food, verifying ingredients, and navigating Islamic dietary requirements worldwide.</p>
            </div>

            <!-- Feature Cards -->
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
                <div class="feature-card bg-white rounded-xl p-6 shadow-lg cursor-pointer" onclick="showSection('restaurant')">
                    <div class="text-4xl mb-4">üçΩÔ∏è</div>
                    <h3 class="text-xl font-bold text-emerald-800 mb-2">Restaurant Finder</h3>
                    <p class="text-slate-600 text-sm">Discover Halal-certified restaurants, Muslim-owned eateries, and Halal-friendly dining options near you.</p>
                </div>

                <div class="feature-card bg-white rounded-xl p-6 shadow-lg cursor-pointer" onclick="showSection('ingredient')">
                    <div class="text-4xl mb-4">üîç</div>
                    <h3 class="text-xl font-bold text-emerald-800 mb-2">Ingredient Checker</h3>
                    <p class="text-slate-600 text-sm">Verify if ingredients and products are Halal. Identify hidden Haram components instantly.</p>
                </div>

                <div class="feature-card bg-white rounded-xl p-6 shadow-lg cursor-pointer" onclick="showSection('travel')">
                    <div class="text-4xl mb-4">‚úàÔ∏è</div>
                    <h3 class="text-xl font-bold text-emerald-800 mb-2">Travel Assistant</h3>
                    <p class="text-slate-600 text-sm">Find Halal food anywhere in the world. Get local phrases and dining tips for travelers.</p>
                </div>

                <div class="feature-card bg-white rounded-xl p-6 shadow-lg cursor-pointer" onclick="showSection('recipe')">
                    <div class="text-4xl mb-4">üë®‚Äçüç≥</div>
                    <h3 class="text-xl font-bold text-emerald-800 mb-2">Halal Recipes</h3>
                    <p class="text-slate-600 text-sm">Browse authentic Halal recipes and learn ingredient substitutions for your favorite dishes.</p>
                </div>

                <div class="feature-card bg-white rounded-xl p-6 shadow-lg">
                    <div class="text-4xl mb-4">üè¢</div>
                    <h3 class="text-xl font-bold text-emerald-800 mb-2">Certification Guide</h3>
                    <p class="text-slate-600 text-sm">Learn about global Halal certification bodies: JAKIM, HFA, IFANCA, MUI, HMC, and more.</p>
                </div>

                <div class="feature-card bg-white rounded-xl p-6 shadow-lg cursor-pointer" onclick="showSection('chat')">
                    <div class="text-4xl mb-4">üí¨</div>
                    <h3 class="text-xl font-bold text-emerald-800 mb-2">AI Assistant</h3>
                    <p class="text-slate-600 text-sm">Ask anything about Halal food, dietary laws, or get personalized recommendations.</p>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="bg-gradient-to-r from-emerald-600 to-teal-600 rounded-2xl p-8 text-white">
                <h3 class="text-2xl font-bold mb-6 text-center">Trusted by Muslims Worldwide</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                    <div>
                        <div class="text-3xl font-bold mb-2">10,000+</div>
                        <div class="text-emerald-100 text-sm">Verified Restaurants</div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold mb-2">150+</div>
                        <div class="text-emerald-100 text-sm">Countries Covered</div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold mb-2">5,000+</div>
                        <div class="text-emerald-100 text-sm">Verified Ingredients</div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold mb-2">24/7</div>
                        <div class="text-emerald-100 text-sm">AI Support</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESTAURANT FINDER SECTION -->
        <div id="section-restaurant" class="section-content hidden">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h2 class="text-3xl font-bold text-emerald-800 mb-6">üçΩÔ∏è Find Halal Restaurants</h2>
                
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Location</label>
                        <input type="text" id="location" placeholder="Enter city, country, or address" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Cuisine Type</label>
                            <select id="cuisine" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                <option value="">All Cuisines</option>
                                <option value="middle-eastern">Middle Eastern</option>
                                <option value="south-asian">South Asian</option>
                                <option value="southeast-asian">Southeast Asian</option>
                                <option value="mediterranean">Mediterranean</option>
                                <option value="western">Western</option>
                                <option value="african">African</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Certification</label>
                            <select id="certification" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                <option value="">All Types</option>
                                <option value="certified">Halal Certified</option>
                                <option value="muslim-owned">Muslim-Owned</option>
                                <option value="halal-friendly">Halal-Friendly</option>
                            </select>
                        </div>
                    </div>
                    
                    <button onclick="searchRestaurants()" class="w-full py-3 bg-emerald-600 text-white rounded-lg font-semibold hover:bg-emerald-700 transition">
                        üîç Search Restaurants
                    </button>
                </div>
                
                <div id="restaurant-results" class="space-y-4"></div>
            </div>
        </div>

        <!-- INGREDIENT CHECKER SECTION -->
        <div id="section-ingredient" class="section-content hidden">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h2 class="text-3xl font-bold text-emerald-800 mb-6">üîç Check Ingredients</h2>
                
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Product Name or Ingredient List</label>
                        <textarea id="ingredients" rows="5" placeholder="Enter product name (e.g., 'Snickers bar') or paste ingredient list" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                    </div>
                    
                    <button onclick="checkIngredients()" class="w-full py-3 bg-emerald-600 text-white rounded-lg font-semibold hover:bg-emerald-700 transition">
                        ‚úÖ Analyze Ingredients
                    </button>
                </div>
                
                <!-- Common Haram Ingredients Reference -->
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                    <h3 class="font-bold text-amber-900 mb-2">‚ö†Ô∏è Common Haram Ingredients to Watch:</h3>
                    <div class="grid md:grid-cols-2 gap-2 text-sm text-amber-800">
                        <div>‚Ä¢ Pork (ham, bacon, lard)</div>
                        <div>‚Ä¢ Alcohol (ethanol, wine, beer)</div>
                        <div>‚Ä¢ Non-Halal gelatin</div>
                        <div>‚Ä¢ Animal rennet (non-Halal)</div>
                        <div>‚Ä¢ Certain E-numbers</div>
                        <div>‚Ä¢ Vanilla extract (alcohol-based)</div>
                    </div>
                </div>
                
                <div id="ingredient-results" class="space-y-4"></div>
            </div>
        </div>

        <!-- TRAVEL GUIDE SECTION -->
        <div id="section-travel" class="section-content hidden">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h2 class="text-3xl font-bold text-emerald-800 mb-6">‚úàÔ∏è Travel Guide</h2>
                
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Destination</label>
                        <input type="text" id="destination" placeholder="Which city or country are you visiting?" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    
                    <button onclick="getTravelGuide()" class="w-full py-3 bg-emerald-600 text-white rounded-lg font-semibold hover:bg-emerald-700 transition">
                        üó∫Ô∏è Get Travel Guide
                    </button>
                </div>
                
                <!-- Travel Tips -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                    <h3 class="font-bold text-blue-900 mb-3">üí° Travel Tips:</h3>
                    <ul class="space-y-2 text-sm text-blue-800">
                        <li>‚úì Download offline Halal restaurant apps before traveling</li>
                        <li>‚úì Learn key phrases in local language: "Is this Halal?" "Does this contain pork/alcohol?"</li>
                        <li>‚úì Research Muslim-majority neighborhoods for more options</li>
                        <li>‚úì Check for prayer facilities near restaurants</li>
                        <li>‚úì Always verify certification with restaurant staff</li>
                    </ul>
                </div>
                
                <div id="travel-results" class="space-y-4"></div>
            </div>
        </div>

        <!-- RECIPE SECTION -->
        <div id="section-recipe" class="section-content hidden">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h2 class="text-3xl font-bold text-emerald-800 mb-6">üë®‚Äçüç≥ Halal Recipes</h2>
                
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">What would you like to cook?</label>
                        <input type="text" id="recipe-query" placeholder="e.g., chicken biryani, beef stew, desserts" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    
                    <button onclick="getRecipe()" class="w-full py-3 bg-emerald-600 text-white rounded-lg font-semibold hover:bg-emerald-700 transition">
                        üç≥ Get Recipe
                    </button>
                </div>
                
                <!-- Quick Recipe Ideas -->
                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <button onclick="quickRecipe('chicken biryani')" class="p-4 bg-emerald-50 rounded-lg hover:bg-emerald-100 transition text-left">
                        <div class="text-2xl mb-2">üçõ</div>
                        <div class="font-semibold text-emerald-800">Chicken Biryani</div>
                        <div class="text-xs text-slate-600">Aromatic rice dish</div>
                    </button>
                    <button onclick="quickRecipe('lamb kebab')" class="p-4 bg-emerald-50 rounded-lg hover:bg-emerald-100 transition text-left">
                        <div class="text-2xl mb-2">ü•ô</div>
                        <div class="font-semibold text-emerald-800">Lamb Kebab</div>
                        <div class="text-xs text-slate-600">Grilled perfection</div>
                    </button>
                    <button onclick="quickRecipe('baklava')" class="p-4 bg-emerald-50 rounded-lg hover:bg-emerald-100 transition text-left">
                        <div class="text-2xl mb-2">üç∞</div>
                        <div class="font-semibold text-emerald-800">Baklava</div>
                        <div class="text-xs text-slate-600">Sweet pastry</div>
                    </button>
                </div>
                
                <div id="recipe-results" class="space-y-4"></div>
            </div>
        </div>

        <!-- CHAT SECTION -->
        <div id="section-chat" class="section-content hidden">
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                <div class="bg-gradient-to-r from-emerald-600 to-teal-600 p-6 text-white">
                    <h2 class="text-2xl font-bold mb-2">üí¨ AI Chat Assistant</h2>
                    <p class="text-emerald-100 text-sm">Ask me anything about Halal food, dietary laws, or get personalized recommendations</p>
                </div>
                
                <div id="chatContainer" class="h-96 overflow-y-auto p-6 space-y-4 bg-slate-50">
                    <div class="chat-message bg-emerald-100 rounded-lg p-4 max-w-2xl">
                        <p class="text-sm text-emerald-900">
                            <strong>HalalFind AI:</strong> Assalamu Alaikum! üëã I'm your Halal food expert. I can help you with:
                            <br>‚Ä¢ Finding Halal restaurants anywhere in the world
                            <br>‚Ä¢ Verifying if ingredients and products are Halal
                            <br>‚Ä¢ Explaining Islamic dietary laws and gray areas
                            <br>‚Ä¢ Travel dining guidance and local phrases
                            <br>‚Ä¢ Recipe suggestions and cooking tips
                            <br>‚Ä¢ Halal certification information
                            <br><br>How can I assist you today?
                        </p>
                    </div>
                </div>

                <div class="p-4 bg-white border-t border-slate-200">
                    <div class="flex gap-2 mb-3">
                        <input 
                            type="text" 
                            id="userInput" 
                            placeholder="Ask about Halal food, restaurants, ingredients, travel tips..."
                            class="flex-1 px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                            onkeypress="if(event.key === 'Enter') sendMessage()"
                        >
                        <button 
                            onclick="sendMessage()" 
                            class="px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition font-semibold"
                        >
                            Send
                        </button>
                    </div>
                    
                    <!-- Quick Questions -->
                    <div class="flex flex-wrap gap-2">
                        <button onclick="quickChat('Is gelatin Halal?')" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded-full text-xs text-slate-700 transition">
                            Is gelatin Halal?
                        </button>
                        <button onclick="quickChat('Find Halal restaurants in London')" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded-full text-xs text-slate-700 transition">
                            Restaurants in London
                        </button>
                        <button onclick="quickChat('What is Halal certification?')" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded-full text-xs text-slate-700 transition">
                            What is certification?
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="bg-slate-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="mb-2">üïå HalalFind AI - Powered by Google AI (Gemini)</p>
            <p class="text-slate-400 text-sm">Helping Muslims discover Halal food worldwide with cultural sensitivity</p>
            <p class="text-slate-500 text-xs mt-4">Always verify Halal status with establishments. Not a substitute for religious guidance.</p>
        </div>
    </footer>

    <script type="module">
        // Get API key from localStorage
        let API_KEY = localStorage.getItem('gemini_api_key') || '';
        
        // System prompt for the AI
        const SYSTEM_PROMPT = `You are an AI assistant specialized in Halal food discovery, certification, and Islamic dietary guidance. Your purpose is to help users find Halal restaurants, products, and information while being culturally sensitive and religiously accurate.

Core Responsibilities:
1. Restaurant & Food Discovery - Recommend Halal-certified restaurants based on location
2. Halal Verification & Guidance - Explain Islamic dietary laws and identify Haram ingredients
3. Product Recommendations - Suggest Halal-certified packaged foods
4. Travel & Dining Assistance - Help travelers find Halal food globally
5. Recipe & Cooking Support - Share Halal recipes and substitutions

Response Guidelines:
- Be respectful, friendly, and culturally sensitive
- Only confirm Halal status with reliable information
- Distinguish between certified Halal, Muslim-owned, and Halal-friendly
- Respect different Islamic schools of thought
- Provide detailed, structured responses

When recommending restaurants, use this format:
**Restaurant Name**
- Certification: [Type]
- Cuisine: [Type]
- Location: [Address]
- Specialties: [Dishes]
- Notes: [Info]

Common Haram ingredients: pork, alcohol, non-Halal gelatin, certain enzymes, animal rennet from non-Halal sources.

Major certification bodies: JAKIM, HFA, IFANCA, MUI, HMC`;

        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');

        // Section management
        window.showSection = function(section) {
            document.querySelectorAll('.section-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.remove('tab-active'));
            
            document.getElementById(`section-${section}`).classList.remove('hidden');
            document.getElementById(`tab-${section}`).classList.add('tab-active');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // Chat functions
        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isUser ? 'bg-emerald-600 text-white ml-auto' : 'bg-white'} rounded-lg p-4 max-w-2xl ${isUser ? 'text-right' : ''}`;
            
            const content = document.createElement('div');
            content.className = 'text-sm';
            content.innerHTML = isUser 
                ? `<strong>You:</strong> ${escapeHtml(text)}`
                : `<strong>HalalFind AI:</strong> ${formatResponse(text)}`;
            
            messageDiv.appendChild(content);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading';
            loadingDiv.className = 'chat-message bg-white rounded-lg p-4 max-w-md';
            loadingDiv.innerHTML = '<p class="text-sm loading-dots">Thinking<span>.</span><span>.</span><span>.</span></p>';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeLoading() {
            const loading = document.getElementById('loading');
            if (loading) loading.remove();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatResponse(text) {
            // Convert markdown-style formatting to HTML
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\n/g, '<br>');
            text = text.replace(/- (.*?)(<br>|$)/g, '‚Ä¢ $1$2');
            return text;
        }

        async function callGeminiAPI(message, context = '') {
            const fullPrompt = context ? `${SYSTEM_PROMPT}\n\n${context}\n\nUser: ${message}` : `${SYSTEM_PROMPT}\n\nUser: ${message}`;
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: fullPrompt }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 2048,
                    }
                })
            });

            const data = await response.json();
            if (data.candidates && data.candidates[0]) {
                return data.candidates[0].content.parts[0].text;
            }
            throw new Error('No response from AI');
        }

        // Main chat function
        window.sendMessage = async function() {
            const message = userInput.value.trim();
            if (!message) return;

            addMessage(message, true);
            userInput.value = '';

            // Check if API key is set
            if (!API_KEY) {
                const key = prompt('Please enter your Google AI API key (get it free at https://aistudio.google.com/app/apikey):');
                if (key) {
                    API_KEY = key;
                    localStorage.setItem('gemini_api_key', key);
                } else {
                    addMessage('‚ö†Ô∏è You need a Google AI API key to use this feature. Get one free at: https://aistudio.google.com/app/apikey', false);
                    return;
                }
            }

            showLoading();

            try {
                const response = await callGeminiAPI(message);
                removeLoading();
                addMessage(response, false);
            } catch (error) {
                removeLoading();
                addMessage('‚ùå Error: Unable to get response. Please check your API key and try again.', false);
                console.error('Error:', error);
            }
        };

        window.quickChat = function(query) {
            userInput.value = query;
            sendMessage();
        };

        // Restaurant search
        window.searchRestaurants = async function() {
            const location = document.getElementById('location').value;
            const cuisine = document.getElementById('cuisine').value;
            const certification = document.getElementById('certification').value;
            
            if (!location) {
                alert('Please enter a location');
                return;
            }

            const resultsDiv = document.getElementById('restaurant-results');
            resultsDiv.innerHTML = '<div class="text-center py-8"><div class="loading-dots text-emerald-600">Searching<span>.</span><span>.</span><span>.</span></div></div>';

            // Check if API key is set
            if (!API_KEY) {
                const key = prompt('Please enter your Google AI API key (get it free at https://aistudio.google.com/app/apikey):');
                if (key) {
                    API_KEY = key;
                    localStorage.setItem('gemini_api_key', key);
                } else {
                    resultsDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">‚ö†Ô∏è You need a Google AI API key. Get one free at: https://aistudio.google.com/app/apikey</div>';
                    return;
                }
            }

            try {
                let query = `Find Halal restaurants in ${location}`;
                if (cuisine) query += ` with ${cuisine} cuisine`;
                if (certification) query += ` that are ${certification}`;
                query += `. Provide at least 5 detailed recommendations with certification status, location, and specialties.`;

                const response = await callGeminiAPI(query);
                resultsDiv.innerHTML = `<div class="bg-emerald-50 border border-emerald-200 rounded-lg p-6">${formatResponse(response)}</div>`;
            } catch (error) {
                resultsDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">‚ùå Error searching restaurants. Please try again.</div>';
            }
        };

        // Ingredient checker
        window.checkIngredients = async function() {
            const ingredients = document.getElementById('ingredients').value.trim();
            
            if (!ingredients) {
                alert('Please enter product name or ingredients');
                return;
            }

            const resultsDiv = document.getElementById('ingredient-results');
            resultsDiv.innerHTML = '<div class="text-center py-8"><div class="loading-dots text-emerald-600">Analyzing<span>.</span><span>.</span><span>.</span></div></div>';

            // Check if API key is set
            if (!API_KEY) {
                const key = prompt('Please enter your Google AI API key (get it free at https://aistudio.google.com/app/apikey):');
                if (key) {
                    API_KEY = key;
                    localStorage.setItem('gemini_api_key', key);
                } else {
                    resultsDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">‚ö†Ô∏è You need a Google AI API key. Get one free at: https://aistudio.google.com/app/apikey</div>';
                    return;
                }
            }

            try {
                const query = `Analyze these ingredients for Halal status: "${ingredients}". List each ingredient, identify any Haram components, explain why they're problematic, and suggest Halal alternatives if needed. Be specific about common issues like gelatin sources, alcohol, and enzymes.`;

                const response = await callGeminiAPI(query);
                resultsDiv.innerHTML = `<div class="bg-white border border-slate-200 rounded-lg p-6">${formatResponse(response)}</div>`;
            } catch (error) {
                resultsDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">‚ùå Error analyzing ingredients. Please try again.</div>';
            }
        };

        // Travel guide
        window.getTravelGuide = async function() {
            const destination = document.getElementById('destination').value.trim();
            
            if (!destination) {
                alert('Please enter a destination');
                return;
            }

            const resultsDiv = document.getElementById('travel-results');
            resultsDiv.innerHTML = '<div class="text-center py-8"><div class="loading-dots text-emerald-600">Preparing guide<span>.</span><span>.</span><span>.</span></div></div>';

            // Check if API key is set
            if (!API_KEY) {
                const key = prompt('Please enter your Google AI API key (get it free at https://aistudio.google.com/app/apikey):');
                if (key) {
                    API_KEY = key;
                    localStorage.setItem('gemini_api_key', key);
                } else {
                    resultsDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">‚ö†Ô∏è You need a Google AI API key. Get one free at: https://aistudio.google.com/app/apikey</div>';
                    return;
                }
            }

            try {
                const query = `Create a comprehensive Halal travel guide for ${destination}. Include: 1) Best Halal restaurants with addresses, 2) Muslim-friendly neighborhoods, 3) Useful local phrases for asking about Halal food, 4) Prayer facilities locations, 5) Travel tips specific to this destination. Be detailed and practical.`;

                const response = await callGeminiAPI(query);
                resultsDiv.innerHTML = `<div class="bg-blue-50 border border-blue-200 rounded-lg p-6">${formatResponse(response)}</div>`;
            } catch (error) {
                resultsDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">‚ùå Error getting travel guide. Please try again.</div>';
            }
        };

        // Recipe function
        window.getRecipe = async function() {
            const query = document.getElementById('recipe-query').value.trim();
            
            if (!query) {
                alert('Please enter what you want to cook');
                return;
            }

            const resultsDiv = document.getElementById('recipe-results');
            resultsDiv.innerHTML = '<div class="text-center py-8"><div class="loading-dots text-emerald-600">Finding recipe<span>.</span><span>.</span><span>.</span></div></div>';

            // Check if API key is set
            if (!API_KEY) {
                const key = prompt('Please enter your Google AI API key (get it free at https://aistudio.google.com/app/apikey):');
                if (key) {
                    API_KEY = key;
                    localStorage.setItem('gemini_api_key', key);
                } else {
                    resultsDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">‚ö†Ô∏è You need a Google AI API key. Get one free at: https://aistudio.google.com/app/apikey</div>';
                    return;
                }
            }

            try {
                const recipeQuery = `Provide a detailed Halal recipe for ${query}. Include: ingredients list with Halal specifications, step-by-step instructions, cooking time, servings, and tips for ensuring all ingredients are Halal. If any ingredients have Haram alternatives commonly used, mention Halal substitutions.`;

                const response = await callGeminiAPI(recipeQuery);
                resultsDiv.innerHTML = `<div class="bg-amber-50 border border-amber-200 rounded-lg p-6">${formatResponse(response)}</div>`;
            } catch (error) {
                resultsDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">‚ùå Error getting recipe. Please try again.</div>';
            }
        };

        window.quickRecipe = function(recipe) {
            document.getElementById('recipe-query').value = recipe;
            getRecipe();
        };

        // API Key Management
        window.manageAPIKey = function() {
            const currentKey = API_KEY ? '(Already set)' : '(Not set)';
            const action = confirm(`Current API Key: ${currentKey}\n\nDo you want to change it?\n\nClick OK to enter a new key\nClick Cancel to remove the current key`);
            
            if (action) {
                const newKey = prompt('Enter your Google AI API key:\n(Get it free at https://aistudio.google.com/app/apikey)');
                if (newKey) {
                    API_KEY = newKey;
                    localStorage.setItem('gemini_api_key', newKey);
                    alert('‚úÖ API key saved successfully!');
                }
            } else {
                if (confirm('Are you sure you want to remove the API key?')) {
                    API_KEY = '';
                    localStorage.removeItem('gemini_api_key');
                    alert('‚úÖ API key removed.');
                }
            }
        };
    </script>

    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/HalalfoodAI/sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }
    </script>
</body>
</html>
